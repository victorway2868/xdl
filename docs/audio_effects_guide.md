# 音效助手功能说明

## 功能概述

音效助手页面提供了完整的音效管理功能，包括：

1. **音效包自动更新** - 从服务器自动下载新的音效包
2. **音效播放** - 点击音效按钮即可播放对应音效
3. **快捷键设置** - 为每个音效设置键盘快捷键
4. **拖拽排序** - 支持拖拽重新排列音效顺序
5. **锁定功能** - 锁定后防止误操作

## 技术实现

### 音效包更新机制

- **服务器地址**: `https://xiaodouli.openclouds.dpdns.org/SoundEffects/soundeffects.json`
- **更新策略**: 仅在每次软件启动后第一次进入音效页面时检查更新
- **本地存储**: 音效文件存储在用户数据目录的 `SoundEffects` 文件夹中
- **格式支持**: MP3, WAV, OGG, M4A, AAC

### 音效包JSON格式

```json
{
  "files": [
    {
      "name": "sfx_pack1",
      "url": "https://cdn.example.com/sfx/sfx_pack1.zip"
    },
    {
      "name": "sfx_pack2", 
      "url": "https://cdn.example.com/sfx/sfx_pack2.zip"
    }
  ]
}
```

### 文件夹结构

```
用户数据目录/
└── SoundEffects/
    ├── sfx_pack1/
    │   ├── sound1.mp3
    │   ├── sound2.wav
    │   └── ...
    ├── sfx_pack2/
    │   ├── effect1.mp3
    │   ├── effect2.ogg
    │   └── ...
    └── ...
```

## 使用说明

### 访问音效助手

1. 点击标题栏的音效按钮（🎵图标）
2. 或通过导航菜单进入音效设置页面

### 添加音效

1. 点击"+"按钮打开音效选择对话框
2. 从可用音效列表中选择要添加的音效
3. 音效会自动添加到面板中

### 设置快捷键

1. 点击音效卡片右上角的设置按钮
2. 在弹出的对话框中输入快捷键组合
3. 点击确定保存设置

### 播放音效

- 直接点击音效卡片即可播放对应音效
- 使用设置的快捷键也可以播放音效

### 重新排序

1. 确保音效面板未锁定（绿色解锁图标）
2. 拖拽音效卡片到目标位置
3. 松开鼠标完成排序

### 删除音效

1. 确保音效面板未锁定
2. 将音效卡片拖拽到面板外部区域
3. 松开鼠标即可删除

### 锁定/解锁

- 点击右上角的锁定按钮切换锁定状态
- 锁定状态下无法拖拽、删除或设置音效
- 绿色图标表示解锁，红色图标表示锁定

## 优化改进

相比原版本的改进：

1. **网络请求优化** - 通过主进程处理网络请求，避免CSP问题
2. **错误处理增强** - 完善的错误提示和日志记录
3. **性能优化** - 仅在首次访问时检查更新，避免重复请求
4. **用户体验** - 更好的加载状态提示和操作反馈
5. **类型安全** - 完整的TypeScript类型定义
6. **音效预览** - 在选择音效时可以预览播放

## 故障排除

### 音效包下载失败

1. 检查网络连接
2. 查看应用日志获取详细错误信息
3. 手动点击"更新音效包"按钮重试

### 音效播放失败

1. 确认音效文件存在且格式正确
2. 检查系统音频设备是否正常
3. 查看应用日志获取错误详情
4. Windows用户：确保系统已安装Windows Media Player
5. 检查音频文件是否损坏或格式不支持

### 音频播放技术说明

- **Windows**: 使用Windows Media Player COM对象，支持MP3、WAV、WMA等格式
- **macOS**: 使用系统内置的afplay命令
- **Linux**: 使用PulseAudio (paplay) 或ALSA (aplay)

### 快捷键设置问题

1. 确认快捷键组合是否与其他应用冲突
2. 检查应用是否有足够的系统权限
3. 重启应用后重新设置快捷键

### 快捷键不生效

1. 确认快捷键组合格式正确
2. 检查是否与系统快捷键冲突
3. 重新设置快捷键

## 技术架构

### 主要组件

- `AudioSettingsPage.tsx` - 音效助手主页面组件
- `src/main/handlers/audio.ts` - 音效相关的主进程API处理器
- `AudioPreviewModal` - 音效选择对话框组件
- `HotkeySettingModal` - 快捷键设置对话框组件

### 数据流

1. 渲染进程通过IPC调用主进程API
2. 主进程处理文件操作和网络请求
3. 音效配置保存在localStorage中
4. 音效文件存储在用户数据目录中

### 安全考虑

- 所有网络请求通过主进程处理
- 文件路径验证防止路径遍历攻击
- 音效文件类型白名单限制